#!/usr/bin/env bash

# OA: Gavin Vales
# CREATED: Mon  7 Oct 23:04:04 BST 2019
# source /home/gavarch/.config/user-dirs.dirs

SDR=${USER_SCR_DIR}


help () {
cat << 'EOB'
# NAME

__manner__ - generates man pages for scripts

# SYNOPSIS

```
manner [--directory|-d <directory>] [--install|-i copy|link]
manner --script|-s <script>
manner --help|-h
```

# DEPENDENCIES

```
pandoc
```

# OPTIONS

`--directory|-d <directory>`  
Change target directory

`--script|-s <script>`  
Call specified <script> with `--help` flag, and convert
the output to a man page with `pandoc -s -t man`.

`--install|-i copy|link`  
Install all the manpages in `<directory>`man to
`/usr/share/man/man1` if they do not already exist.

Argument to this option determines whether the scripts
are copied or linked.

`--help|-h`  
Print this help

# DESCRIPTION

All my bash scripts that have a help function are just
called with the `--help` flag and the output piped to
`pandoc -s -t man`, and that output redirected to the
directory `<directory>`man. The default directory is
`$HOME/scr`, so the resulting manpages will be redirected
to the appropriate file in `$HOME/scrman`.

Note that this only works because all my help functions
are written in markdown.

The `--script` flag can be used to automatically pipe the
output of the specified script to a man page.

EOB
exit
}

while true; do
	case $1 in
		--directory | -d ) SDR="${2:-}" ;;
		--install   | -i ) INS="${2:-}" ;;
		--script    | -s ) ${2:-} --help | pandoc -s -t man | man -l - ; exit ;;
		--help | -h ) help ;;
		-- ) shift ; break ;;
		*  ) break         ;;
	esac
	shift
done

SRC=${SDR}
TRG=${SDR}man

cd $SRC

for i in $(ls -l | sed '/^d/d;/^total/d' | awk '{print $NF}'); do
	[[ -n $(grep '\-\-help' $i) ]] && {

		echo "$i"

		echo ".TH ${i^^} 1 $(date +%F | sed 's/-/\\-/g') Linux \"User Manuals\"" > ${TRG}/${i}.1

		$i --help | pandoc -s -t man | sed \
			'/^.\\"/d;/.TH "" "" "" "" ""/d;s/^\\f\[C\]$/PRECODE/g;s/\\f\[C\]/\\f\[B\]/g;s/PRECODE/\\f\[C\]/g' \
			>> ${TRG}/${i}.1

		[[ -z $INS ]] || [[ ! -f /usr/share/man/man1/${i}.1 ]] && {
			[[ $INS == "copy" ]] && \
				sudo cp      ${TRG}/${i}.1 /usr/share/man/man1/${i}.1
			[[ $INS == "link" ]] && \
				sudo ln -sf  ${TRG}/${i}.1 /usr/share/man/man1/${i}.1
			}

		}
done
