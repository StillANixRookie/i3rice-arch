#!/usr/bin/env bash

# OA: Gavin Vales
# CREATED: Sat 16 Mar 20:08:40 GMT 2019
# requires dmenu-manjaro

ttlbr=24
brdr=4
prmt=""
lines="15"
loc="1"
xoffset="0"
yoffset="0"
wnloc=$(xdotool getactivewindow getwindowgeometry | grep 'Position' | awk '{print $2}')
wngeo=$(xdotool getactivewindow getwindowgeometry | grep 'Geometry' | awk '{print $2}')
wnX=${wnloc%,*}
wnY=${wnloc#*,}
wnW=${wngeo%x*}
wnH=${wngeo#*x}
msX=$(xdotool getmouselocation | awk '{print $1}')
msY=$(xdotool getmouselocation | awk '{print $2}')
mon=$(xdotool getmouselocation | awk '{print $3}')

bkd=$(xrdb -query | grep '*color8' | awk '{print $NF}')
wtl=$(xrdb -query | grep '*color15' | awk '{print $NF}')
blu=$(xrdb -query | grep '*color4' | awk '{print $NF}')
fnt=$(xrdb -query | grep 'URxvt.font' | awk '{print $NF}')
fnt=${fnt%:*}
fnt=${fnt##*:}

dmthm="-fn "${fnt}:size=11" -nb "$bkd" -nf "$wtl" -sf "$bkd" -sb "$blu""
mslocx="-xoffset ${msX:2}"
mslocy="-yoffset ${msY:2}"
wnlocx="-xoffset $(expr $wnX - $brdr) "
wnlocy="-yoffset $(expr $wnY - $ttlbr)"
dmloc="-x $(expr $wnX - $brdr) -y $(expr $wnY - $ttlbr)"

menu () {
	rofi -dmenu -monitor ${mon:7} -location $loc -lines $lines -p "${prmt}" \
		-width 500 -xoffset $xoffset -yoffset $yoffset
}

start-button () {
	rofi -show drun -theme bmenu -monitor ${mon:7} -location $loc -lines $lines -width 500 -xoffset $xoffset -yoffset $yoffset
}

dmenu () {
	dmenu_run $dmloc $dmthm -w $(expr $wnW + $brdr + $brdr) -h $ttlbr
}

#if [[ ${prmt} == "-run" ]]; then
#	dmenu
#else
#	centre
#fi

while getopts :dsp:t:m:w:l:x:y: opts; do
	case $opts in
		d)
			dmenu
			exit
			;;
		s)
			start-button
			exit
			;;
		p)
			prmt=${OPTARG}
			;;
		t)
			xoffset=$(expr $wnX - $brdr)
			yoffset=$(expr $wnY - $ttlbr)
			;;
		m)
			xoffset=${msX:2}
			yoffset=${msY:2}
			;;
		w)
			xoffset=$(expr $wnX - $brdr)
			yoffset=$(expr $wnY - $ttlbr)
			;;
		l)
			loc=${OPTARG}
			;;
		x)
			xoffset=${OPTARG}
			;;
		y)
			yoffset=${OPTARG}
			;;
	esac
done

menu
