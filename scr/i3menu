#!/usr/bin/env bash

# OA: Gavin Vales
# CREATED: Sat 16 Mar 20:08:40 GMT 2019
# requires dmenu-manjaro

rofiDir="$HOME/.config/rofi"
color=blue
theme=vertical
ttlbr=24
brdr=2
prmt=" "
mode="menu"
lines="15"
loc="0"
wdth="500"
xoffset="0"
yoffset="0"
fs=" "
wnloc=$(xdotool getactivewindow getwindowgeometry | grep 'Position' | awk '{print $2}')
wngeo=$(xdotool getactivewindow getwindowgeometry | grep 'Geometry' | awk '{print $2}')
wnX=${wnloc%,*}
wnY=${wnloc#*,}
wnW=${wngeo%x*}
wnH=${wngeo#*x}
msX=$(xdotool getmouselocation | awk '{print $1}')
msY=$(xdotool getmouselocation | awk '{print $2}')
mon=$(xdotool getmouselocation | awk '{print $3}')

bkd=$(xrdb -query | grep '*color8' | awk '{print $NF}')
wtl=$(xrdb -query | grep '*color15' | awk '{print $NF}')
blu=$(xrdb -query | grep '*color9' | awk '{print $NF}')
fnt=$(xrdb -query | grep 'URxvt.font' | awk '{print $NF}')
fnt=${fnt%:*}
fnt=${fnt##*:}
dmthm="-fn "${fnt}:size=11" -nb "$bkd" -nf "$wtl" -sf "$bkd" -sb "$blu""
dmloc="-x $(expr $wnX - $brdr) -y $(expr $wnY - $ttlbr)"

menu () {
	rofi -dmenu -p "${prmt}" $fs -theme $theme -monitor ${mon:7} -location $loc \
		-lines $lines -width $wdth -xoffset $xoffset -yoffset $yoffset \
		-markup-rows
}

start () {
	rofi -show drun -p "${prmt}" $fs -theme $theme -monitor ${mon:7} -location $loc \
		-lines $lines -width $wdth -xoffset $xoffset -yoffset $yoffset
}

dmenu () {
	dmenu_run $dmloc $dmthm -w $(expr $wnW + $brdr + $brdr) -h $ttlbr
}

while getopts :p:l:x:y:c:w:o:dstmf opts; do
	case $opts in
		p)
			prmt="${OPTARG}"
			;;
		l)
			loc="${OPTARG}"
			;;
		x)
			xoffset="$(expr $xoffset + $OPTARG)"
			;;
		y)
			yoffset="$(expr $yoffset + $OPTARG)"
			;;
		c)
			color="${OPTARG}"
			;;
		w)
			wdth="${OPTARG}"
			;;
		o)
			theme="${OPTARG}"
			;;
		d)
			mode="dmenu"
			;;
		s)
			mode="start"
			;;
		t)
			theme=horizontal
			loc=1
			lines=10
			wdth="$(expr $wnW + $brdr + $brdr)"
			xoffset="$(expr $wnX - $brdr)"
			yoffset="$(expr $wnY - $ttlbr)"
			;;
		m)
			theme=vertical
			loc=1
#			wdth=300
			xoffset="${msX:2}"
			yoffset="${msY:2}"
			;;
		f)
			theme=vertical
			loc=0
			fs="-fullscreen"
			;;
	esac
done

cat $rofiDir/${color}.rasi > $rofiDir/globals.rasi

$mode
