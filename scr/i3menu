#!/usr/bin/env bash

# OA: Gavin Vales
# CREATED: Sat 16 Mar 20:08:40 GMT 2019
# requires dmenu-manjaro

# >>>> vars
rofiDir="$HOME/.config/rofi"
COLOR=blue
THM=vertical
TTLBR=26
BRDR=2
PRMT=" "
MODE="menu"
LNS="15"
LOC="0"
WDTH="500"
HGTH="50%"
XOFFSET="0"
YOFFSET="0"
fs=" "
wnloc=$(xdotool getactivewindow getwindowgeometry | grep 'Position' | awk '{print $2}')
wngeo=$(xdotool getactivewindow getwindowgeometry | grep 'Geometry' | awk '{print $2}')
wnX=${wnloc%,*}
wnY=${wnloc#*,}
wnW=${wngeo%x*}
wnH=${wngeo#*x}
sc=$(xdpyinfo | grep dimensions | awk '{print $2}')
scW=${sc%x*}
scH=${sc#*x}
msX=$(xdotool getmouselocation | awk '{print $1}')
msY=$(xdotool getmouselocation | awk '{print $2}')
mon=$(xdotool getmouselocation | awk '{print $3}')

# >>>> dmenu colors
bkd=$(xrdb -query | grep '*color8' | awk '{print $NF}')
wtl=$(xrdb -query | grep '*color15' | awk '{print $NF}')
blu=$(xrdb -query | grep '*color9' | awk '{print $NF}')
fnt=$(xrdb -query | grep 'URxvt.font' | awk '{print $NF}')
fnt=${fnt%:*}
fnt=${fnt##*:}
dmthm="-fn "${fnt}:size=11" -nb "$bkd" -nf "$wtl" -sf "$bkd" -sb "$blu""
dmloc="-x $(expr $wnX - $BRDR) -y $(expr $wnY - $TTLBR)"

menu () {
	rofi -dmenu -p "${PRMT}" $fs -theme $THM -monitor ${mon:7} -location $LOC \
		-lines $LNS -width $WDTH -xoffset $XOFFSET -yoffset $YOFFSET \
		-theme-str "#window { height: $HGTH; }" -markup-rows
}
start () {
	rofi -show drun -p "${PRMT}" $fs -theme $THM -monitor ${mon:7} -location $LOC \
		-lines $LNS -width $WDTH -xoffset $XOFFSET -yoffset $YOFFSET \
		-theme-str "#window { height: $HGTH; }"
}
dmenu () {
	dmenu_run $dmloc $dmthm -w $(expr $wnW + $BRDR + $BRDR) -h $TTLBR
}
help () {
	echo "	-h  --  echo this help"
	echo "	-p  --  prompt"
	echo "	-l  --  rofi location"
	echo "	-x  --  horizontal X position"
	echo "	-y  --  vertical X position"
	echo "	-c  --  accent color, comes in the form of the variable files in"
	echo "	            .config/rofi"
	echo "	-w  --  rofi width"
	echo "	-o  --  vertical or horizontal (like dmenu)"
	echo "	-r  --  number of vertical rows"
	echo "	-d  --  dmenu mode"
	echo "	-s  --  application menu mode"
	echo "	-t  --  spawn on i3wm title-bar"
	echo "	-m  --  spawn at mouse location"
	echo "	-f  --  fullscreen mode, working on this"
}
while getopts :p:l:x:y:g:c:w:o:r:dstmfh opts; do
	case $opts in
		p)
			PRMT="${OPTARG}"
			;;
		l)
			LOC="${OPTARG}"
			;;
		x)
			XOFFSET="$(expr $XOFFSET + $OPTARG)"
			;;
		y)
			YOFFSET="$(expr $YOFFSET + $OPTARG)"
			;;
		c)
			COLOR="${OPTARG}"
			;;
		w)
			WDTH="${OPTARG}"
			;;
		g)
			HGTH="${OPTARG}"
			;;
		o)
			THM="${OPTARG}"
			;;
		r)
			LNS="${OPTARG}"
			;;
		d)
			MODE="dmenu"
			;;
		s)
			MODE="start"
			;;
		t)
			LOC=1
			WDTH="$(expr $wnW + $BRDR + $BRDR)"
			[[ $THM == "vertical" ]] \
			&& HGTH=$(echo "((${wnH}*100)/$scH)+((($TTLBR+$TTLBR/2)*100)/$scH)" | bc) \
			&& HGTH="${HGTH}%"
			[[ $THM == "horizontal" ]] && HGTH="0%"
			echo $HGTH
			XOFFSET="$(expr $wnX - $BRDR - $BRDR)"
			YOFFSET="$(expr $wnY - $TTLBR)"
			;;
		m)
			THM=vertical
			LOC=1
			WDTH=300
			XOFFSET="${msX:2}"
			YOFFSET="${msY:2}"
			;;
		f)
			THM=vertical
			LOC=0
			fs="-fullscreen"
			;;
		h)
			help && exit
			;;
	esac
done

cat $rofiDir/${COLOR}.rasi > $rofiDir/globals.rasi

$MODE
