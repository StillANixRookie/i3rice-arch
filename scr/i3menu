#!/usr/bin/env bash

# OA: Gavin Vales
# CREATED: Mon 26 Aug 17:35:49 BST 2019
#iconFu="<span face='Font Awesome 5 Free'>&#xf240;</span>"

RFDIR="$HOME/.config/rofi"
CONFIG="$RFDIR/.i3menuconfig"
BLACK="$RFDIR/black.rasi"
HORI="$RFDIR/_horizontal.rasi"
VERT="$RFDIR/_vertical.rasi"
PROMPT=" " # a comment
MODE="menu"
fs=" "

i3menuconfig () {
	cat > $CONFIG  << 'EOB'
# vim:ft=sh
ACCENT_COLOR=black
ORIENTATION=vertical
TITLEBAR_HEIGHT=25
WINDOW_BORDER=2
LOCATION="0"
WIDTH="300"
HEIGHT=" "
XFS="0"
YFS="0"
WINDOW_LOCATION=$(xdotool getactivewindow getwindowgeometry | \
		grep 'Position' | awk '{print $2}')
WINDOW_GEOMETRY=$(xdotool getactivewindow getwindowgeometry | \
		grep 'Geometry' | awk '{print $2}')
WIN_X=${WINDOW_LOCATION%,*}
WIN_Y=${WINDOW_LOCATION#*,}
WIN_W=${WINDOW_GEOMETRY%x*}
WIN_H=${WINDOW_GEOMETRY#*x}
sc=$(xdpyinfo | grep dimensions | awk '{print $2}')
SCREEN_W=${sc%x*}
SCREEN_H=${sc#*x}
MOUSE_X=$(xdotool getmouselocation | awk '{print $1}')
MOUSE_Y=$(xdotool getmouselocation | awk '{print $2}')
MONITOR=$(xdotool getmouselocation | awk '{print $3}')

#dmenu_bg=$(xrdb -query | grep '*color8' | awk '{print $NF}')
#dmenu_fg=$(xrdb -query | grep '*color15' | awk '{print $NF}')
#dmenu_ac=$(xrdb -query | grep '*color9' | awk '{print $NF}')
#dmenu_fnt=$(xrdb -query | grep 'URxvt.font' | awk '{print $NF}')
#dmenu_fnt=${dmenu_fnt%:*}
#dmenu_fnt=${dmenu_fnt##*:}
#dmenu_thm="-fn "${dmenu_fnt}:size=11" -nb "$dmenu_bg" -nf "$dmenu_fg" -sf "$dmenu_bg" -sb "$dmenu_ac""
#dmenu_loc="-x $(expr $WIN_X - $WINDOW_BORDER - $WINDOW_BORDER) -y $(expr $WIN_Y - $TITLEBAR_HEIGHT)"
EOB

	[[ -f $BLACK ]] || {
		cat > $BLACK  << 'EOB'
* {
accent: #364145;
fg1:    #222D31;
fg2:    #364145;
bg2:    #f8f8f8;
bg1:    #e4e4e4;
redish: #ab4642;
font1: "LuxiMono 13";
}
EOB
		}

	[[ -f $HORI ]] || {
		cat > $HORI  << 'EOB'
@import "globals.rasi"
* {
	background-color: @accent;
	border-color:     @accent;
	text-color:       @bg1;
	font:             @font1;
}
#window {
//	anchor:           north;
//	location:         north;
//	width:            100%;
	padding:          2px;
	children:         [ horibox ];
}
#horibox {
	orientation:      horizontal;
	children:         [ prompt, entry, listview ];
}
#listview {
	layout:           horizontal;
	spacing:          5px;
	lines:            100;
}
#entry {
	expand:           false;
	width:            10em;
}
#element {
	padding:          0px 2px;
}
#element selected {
	background-color: @bg1;
	text-color:       @accent;
}
EOB
		}

	[[ -f $VERT ]] || {
		cat > $VERT  << 'EOB'
@import "globals.rasi"
* {
	background-color: @accent;
	border-color:     @accent;
	text-color:       @bg2;
	font:             @font1;
}
#window {
//	anchor:           north;
//	location:         north;
//	width:            100%;
	padding:          4px;
//	children:         [ horibox ];
}
#horibox {
	children:         [ prompt, entry, listview ];
}
#listview {
	spacing:          5px;
}
#entry {
	expand:           false;
	width:            10em;
}
#element {
	padding:          2px 2px;
}
#element selected {
	background-color: @bg1;
	text-color:       @accent;
}
EOB
	}

}

[[ -f $CONFIG ]] || i3menuconfig
source $CONFIG

dmenu () {
	rofi -show run -p "${PROMPT}" $fs -theme _horizontal -monitor ${MONITOR:7} \
		-location 1 -lines $ROWS -width 100
}

help () {
cat << 'EOB'
  ██ ██████
 ▒▒ ▒█▒▒▒▒█
  ██▒    ▒█ ██████████   █████  ███████  ██   ██
 ▒██   ████▒▒██▒▒██▒▒██ ██▒▒▒██▒▒██▒▒▒██▒██  ▒██
 ▒██  ▒▒▒▒█ ▒██ ▒██ ▒██▒███████ ▒██  ▒██▒██  ▒██
 ▒██ █   ▒█ ▒██ ▒██ ▒██▒██▒▒▒▒  ▒██  ▒██▒██  ▒██
 ▒██▒██████ ███ ▒██ ▒██▒▒██████ ███  ▒██▒▒██████
 ▒▒ ▒▒▒▒▒▒ ▒▒▒  ▒▒  ▒▒  ▒▒▒▒▒▒ ▒▒▒   ▒▒  ▒▒▒▒▒▒
 	-- Rofi wrapper script
 
 Usage
 -----
 i3menu -h                ┼ Print this help
 i3menu -d                ┼ Dmenu mode
 i3menu -s                ┼ Application menu mode
 i3menu -W                ┼ Fill active window
 i3menu -t                ┼ Spawn on i3wm title-bar
 i3menu -m                ┼ Spawn at mouse location
 i3menu -f                ┼ Fullscreen mode, working on this
 i3menu -c [COLOR]        ┼ Accent color; the name of one of
                          │   in the variable files in
                          │   .config/rofi
 i3menu -p [PROMPT]       ┼ Prompt
 i3menu -l [LOCATION]     ┼ Rofi location:  1 2 3
                          │                 8 0 4
                          │                 7 6 5
 i3menu -x [INTEGER]      ┼ Horizontal Offset
 i3menu -y [INTEGER]      ┼ Vertical Offset
 i3menu -w [INTEGER]      ┼ Rofi width
 i3menu -H [INTEGER<=100] ┼ Rofi height (XX% of screen)
 i3menu -o [vertical|     ┼ Vertical or horizontal
           horizontal]    │   (like dmenu)
 i3menu -L [INTEGER]      ┼ Number of vertical rows

EOB
}

start () {
	[[ -n $LNS ]] && ROWS=$LNS || ROWS="15"
	rofi -show drun -p "${PROMPT}" $fs -theme _$ORIENTATION -monitor ${MONITOR:7} \
		-location $LOCATION -lines $ROWS -width $WIDTH -xoffset $XFS -yoffset $YFS \
		-theme-str "#window { $HEIGHT }"
}

menu () {
	STDIN="$RFDIR/.i3menustdin"
	cat /dev/stdin > $STDIN
	[[ -n $LNS ]] && ROWS=$LNS || ROWS=$(cat $STDIN | wc -l)
	cat $STDIN | rofi -dmenu -p "${PROMPT}" $fs -theme _$ORIENTATION -monitor ${MONITOR:7} \
		-location $LOCATION -lines $ROWS -width $WIDTH -xoffset $XFS -yoffset $YFS \
		-theme-str "#window { $HEIGHT }" -markup-rows
	rm -rf $STDIN
}

while getopts :p:l:L:x:y:H:c:w:o:Wdstmfh opts; do
	case $opts in
		p) PROMPT="${OPTARG}"                                            ;;
		l) LOCATION="${OPTARG}"                                          ;;
		L) LNS="${OPTARG}"                                               ;;
		x) XFS="$(expr $XFS + $OPTARG)"                                  ;;
		y) YFS="$(expr $YFS + $OPTARG)"                                  ;;
		c) [[ -f $RFDIR/${OPTARG}.rasi ]] && ACCENT_COLOR="${OPTARG}"    ;;
		w) WIDTH="${OPTARG}"                                             ;;
		H) HEIGHT="height: ${OPTARG};"                                   ;;
		o) ORIENTATION="${OPTARG}"                                       ;;
		W) [[ $ORIENTATION == "vertical" ]] \
				&& HEIGHT=$(echo \
				"((${WIN_H}*100)/$SCREEN_H)+((($TITLEBAR_HEIGHT+$TITLEBAR_HEIGHT/2)*100)/$SCREEN_H)" | bc) \
				&& HEIGHT="height: ${HEIGHT}%;"
			[[ $ORIENTATION == "horizontal" ]] && LNS="15"
			LOCATION=1 WIDTH="$(expr $WIN_W + $WINDOW_BORDER + $WINDOW_BORDER)"
			XFS="$(expr $WIN_X - $WINDOW_BORDER - $WINDOW_BORDER)"
			YFS="$(expr $WIN_Y - $TITLEBAR_HEIGHT)"
			;;
		d) MODE="dmenu"                                                  ;;
		s) MODE="start"                                                  ;;
		t) [[ $ORIENTATION == "horizontal" ]] && LNS="15"
			LOCATION=1 WIDTH="$(expr $WIN_W + $WINDOW_BORDER + $WINDOW_BORDER)"
			XFS="$(expr $WIN_X - $WINDOW_BORDER - $WINDOW_BORDER)"
			YFS="$(expr $WIN_Y - $TITLEBAR_HEIGHT)"
			;;
		m) ORIENTATION=vertical LOCATION=1 WIDTH=300 XFS="${MOUSE_X:2}" YFS="${MOUSE_Y:2}" ;;
		f) ORIENTATION=vertical LOCATION=0 fs="-fullscreen"              ;;
		h) help && exit                                                  ;;
	esac
done

cat $RFDIR/${ACCENT_COLOR}.rasi > $RFDIR/globals.rasi
$MODE
