#!/usr/bin/env bash

cd ${HOME}
FOLDOPEN="thunar" FILEOPEN="edtr"
IMGOPEN="openimage" VIDOPEN="openvid" MUSOPEN="mpc insert"
XBMOPEN="gthumb"    PDFOPEN="zathura" MANOPEN="${TERMINAL:-"urxvt"} -e man"
LST="${HOME}/.config/rofi/.rofindlist"
IGN="${HOME}/.config/rofi/.rofindignore"
#find . -type d \( -path dir1 -o -path dir2 -o -path dir3 \) -prune -o -print

help () {
cat << 'EOB'
# NAME

__rofind__  - `find` wrapper with `rofi`

# DEPENDENCIES

```
rofi
i3menu
```

# SYNOPSIS

```
rofind
rofind --help|-h
```

# DESCRIPTION

Just a `rofi` wrapper for `find`, and opens the chosen item using
an appropriate application.

EOB
exit
}

while true; do
	case $1 in
#		--<++> | -<++> ) <++>="${2:-}" ; shift ;;
		--help ) help ;;
		-h ) help | \
			sed -n "/^__/,/^$/p;/# SYNOPSIS/,/#/p" | \
			sed 's/__.* - /\t/;/^#/d;/^$/d;s/```//g' && exit ;;
		-- ) shift ; break ;;
		*  ) break         ;;
	esac
	shift
done

NORMAL () {
	[[ -d "${1}" ]] && echo Folder && eval "$FOLDOPEN \"${1}\""
	[[ -f "${1}" ]] && echo File   && eval "$FILEOPEN \"${1}\""
}

list () {
	[[ -s $IGN ]] && CMD="$(awk '
		BEGIN{print "find -L . -type d \\( "}
		{ print "-path \""$0"\" -o" }
		END{print " \\) -prune -o -print"}
	' $IGN)" || CMD="find -L . -type d"
	eval "$(echo ${CMD} | sed 's/-o \\)/\\)/g')"
}

flist () {
	list | awk -v HOME="~/" '
		/.png$|.jpeg$|.jpg$|.svg$|.xpm$/{gsub(/^\.\//,HOME,$0);print"PIC "$0}
		/.mp4$|.mkv$|.mov$/             {gsub(/^\.\//,HOME,$0);print"VID "$0}
		/.mp3$/                         {gsub(/^\.\//,HOME,$0);print"MUS "$0}
		/.xbm$/                         {gsub(/^\.\//,HOME,$0);print"XBM "$0}
		/.pdf$|.epub$/                  {gsub(/^\.\//,HOME,$0);print"BKK "$0}
		/.1$/                           {gsub(/^\.\//,HOME,$0);print"MAN "$0}
		!/.png$|.jpeg$|.jpg$|.svg$|.xpm$|.mp4$|.mkv$|.mov$|.mp3$|.xbm$|.pdf$|.epub$|.1$/ {
			gsub(/^\.\//,HOME,$0);print$0
			}
		'
}

#TRG="$(flist | rofi -dmenu -location 0 -lines 15 -width 100)"
TRG="$(flist | i3menu --prompt "rofind" -l 15 -L 0 -w 600)"

case $TRG in
	PIC*) $IMGOPEN "${TRG/'PIC ~'/${HOME}}" ;;
	VID*) $VIDOPEN "${TRG/'VID ~'/${HOME}}" ;;
	MUS*) $MUSOPEN "${TRG/'MUS ~'/${HOME}}" ;;
	XBM*) $XBMOPEN "${TRG/'XBM ~'/${HOME}}" ;;
	BKK*) $PDFOPEN "${TRG/'BKK ~'/${HOME}}" ;;
	MAN*) $MANOPEN "${TRG/'MAN ~'/${HOME}}" ;;
	*)    NORMAL   "${TRG/'~'/${HOME}}" ;;
esac
